name: 🚀 CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-tests:
    name: 🧪 Rust Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🦀 Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: 📦 Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: 🔍 Rust format check
      run: cargo fmt --all -- --check
      continue-on-error: true
      
    - name: 📎 Rust clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
      continue-on-error: true
      
    - name: 🧪 Run Rust unit tests
      run: cargo test --manifest-path programs/meteora-fee-router/Cargo.toml --verbose
      
  build-check:
    name: 🏗️ Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🦀 Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: 🌐 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 📦 Install Node dependencies
      run: npm install
      
    - name: ☀️ Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.16.25/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        
    - name: ⚓ Install Anchor CLI
      run: |
        npm install -g @coral-xyz/anchor-cli@0.29.0
        
    - name: 🏗️ Build program
      run: anchor build
      continue-on-error: true
      
  security-audit:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🦀 Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: 🛡️ Install cargo audit
      run: cargo install cargo-audit
      
    - name: 🔍 Run security audit
      run: cargo audit
      continue-on-error: true