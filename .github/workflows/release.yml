name: ğŸ·ï¸ Release (Disabled)

on:
  workflow_dispatch: # Manual trigger only - DISABLED for bounty submission

permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: ğŸ“ Create release notes
      run: |
        cat > release_notes.md << 'EOF'
        # ğŸ† Meteora Fee Router ${{ steps.tag.outputs.tag }} - Star at Superteam Earn Bounty Submission
        
        ## ğŸ¯ Bounty Features
        - **Quote-Only Fee Collection**: Honorary DAMM v2 LP position with strict enforcement
        - **24-Hour Distribution Crank**: Permissionless system with pagination support
        - **Streamflow Integration**: Real-time vesting schedule reading for proportional distribution
        - **Production Ready**: 304 passing tests with comprehensive coverage
        
        ## ğŸ§ª Testing & Quality
        - âœ… **304 Unit Tests** - All passing with comprehensive coverage
        - âœ… **7 Integration Tests** - End-to-end scenario validation
        - âœ… **Security Audit** - Built-in security validation and overflow protection
        - âœ… **Performance Optimized** - Efficient compute usage for Solana constraints
        
        ## ğŸ“š Documentation
        - Complete integration guides and examples
        - Operational procedures for day-to-day management
        - Security audit summary and best practices
        - Troubleshooting guide for common issues
        
        ## ğŸš€ Deployment
        - Multi-platform deployment scripts (Unix & Windows)
        - Configuration templates for different environments
        - Automated validation and verification tools
        - Production-ready build optimization
        
        ## ğŸ’° Business Value for Star Platform
        - **Immediate Integration**: Ready for Star's fundraising platform
        - **Transparent Fee Sharing**: Automated investor relations
        - **Reduced Operational Costs**: No manual distribution required
        - **Enhanced Trust**: Auditable, on-chain fee distribution
        
        ## ğŸ”— Quick Links
        - [Integration Examples](docs/INTEGRATION_EXAMPLES.md)
        - [Operational Procedures](docs/OPERATIONAL_PROCEDURES.md)
        - [Security Audit Summary](docs/SECURITY_AUDIT_SUMMARY.md)
        - [Bounty Submission Details](BOUNTY_SUBMISSION.md)
        
        ---
        
        **Built for**: Star at Superteam Earn Bounty Program  
        **Category**: DeFi Infrastructure - Meteora DAMM V2 Fee Routing  
        **Status**: Production Ready ğŸš€
        EOF
        
    - name: ğŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: ğŸ† Meteora Fee Router ${{ steps.tag.outputs.tag }} - Bounty Submission
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  build-and-package:
    name: ğŸ“¦ Build & Package
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: ğŸŒ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build program
      run: |
        # Install Solana CLI
        sh -c "$(curl -sSfL https://release.solana.com/v1.16.25/install)"
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        # Install Anchor CLI
        npm install -g @coral-xyz/anchor-cli@0.29.0
        
        # Build with optimization
        anchor build --verifiable
        
    - name: ğŸ“¦ Package for NPM
      run: |
        # Create NPM package structure
        mkdir -p npm-package
        cp -r target/idl npm-package/
        cp -r target/types npm-package/
        cp README.md npm-package/
        cp LICENSE npm-package/
        
        # Create package.json for NPM
        cat > npm-package/package.json << 'EOF'
        {
          "name": "@ashqking/meteora-fee-router",
          "version": "${{ github.ref_name }}",
          "description": "Production-grade Solana program for automated fee distribution with quote-only accrual",
          "main": "types/meteora_fee_router.ts",
          "types": "types/meteora_fee_router.ts",
          "files": [
            "idl/",
            "types/",
            "README.md",
            "LICENSE"
          ],
          "keywords": [
            "solana",
            "anchor",
            "defi",
            "meteora",
            "fee-distribution",
            "streamflow",
            "damm-v2"
          ],
          "author": "@ashqking",
          "license": "MIT",
          "repository": {
            "type": "git",
            "url": "https://github.com/iamaanahmad/meteora-fee-router.git"
          },
          "peerDependencies": {
            "@coral-xyz/anchor": "^0.29.0",
            "@solana/web3.js": "^1.87.0"
          }
        }
        EOF
        
    - name: ğŸ“¤ Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        files: |
          target/deploy/*.so
          target/idl/*.json
          npm-package/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  publish-npm:
    name: ğŸ“¦ Publish to NPM
    runs-on: ubuntu-latest
    needs: build-and-package
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŒ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Download release assets
      uses: actions/download-artifact@v3
      with:
        name: npm-package
        path: ./npm-package
        
    - name: ğŸ“¤ Publish to NPM
      run: |
        cd npm-package
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}